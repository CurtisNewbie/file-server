<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yongj.dao.FileInfoMapper">
  <update id="updateByPrimaryKey" parameterType="com.yongj.dao.FileInfo">
    update file_info
    set name = #{name,jdbcType=VARCHAR},
    uuid = #{uuid,jdbcType=VARCHAR},
    is_logic_deleted = #{isLogicDeleted,jdbcType=INTEGER},
    is_physic_deleted = #{isPhysicDeleted,jdbcType=INTEGER},
    size_in_bytes = #{sizeInBytes,jdbcType=BIGINT},
    uploader_id = #{uploaderId,jdbcType=INTEGER},
    upload_time = #{uploadTime,jdbcType=TIMESTAMP},
    logic_delete_time = #{logicDeleteTime,jdbcType=TIMESTAMP},
    physic_delete_time = #{physicDeleteTime,jdbcType=TIMESTAMP},
    user_group = #{userGroup,jdbcType=INTEGER}
    where id = #{id,jdbcType=INTEGER}
  </update>
  <update id="logicDelete">
    UPDATE file_info
    SET is_logic_deleted = 1,
    logic_delete_time = NOW()
    WHERE id = #{id}
    AND is_logic_deleted = 0
  </update>
  <update id="markFilePhysicDeleted">
    UPDATE file_info
    SET is_physic_deleted = 1,
    physic_delete_time = #{deleteDate}
    WHERE id = #{id}
    AND is_physic_deleted = 0
  </update>
  <update id="updateFileUserGroup">
    UPDATE file_info
    SET user_group = #{userGroup}
    WHERE id = #{id}
  </update>
  <update id="updateInfo">
    update file_info
    <set>
      <if test="userGroup != null">
        user_group = #{userGroup},
      </if>
      <if test="name != null and name != ''">
        name = #{name}
      </if>
    </set>
    where id = #{id}
  </update>
  <select id="selectByPrimaryKey" parameterType="java.lang.Integer" resultType="com.yongj.dao.FileInfo">
    select id, name, uuid, is_logic_deleted, is_physic_deleted, size_in_bytes, uploader_id,
    upload_time, logic_delete_time, physic_delete_time, user_group, fs_group_id
    from file_info
    where id = #{id,jdbcType=INTEGER}
  </select>
  <select id="selectAll" resultType="com.yongj.dao.FileInfo">
    select id, name, uuid, is_logic_deleted, is_physic_deleted, size_in_bytes, uploader_id,
    upload_time, logic_delete_time, physic_delete_time, user_group
    from file_info
  </select>
  <select id="selectBasicInfoByUserId" resultType="com.yongj.dao.FileInfo">
    select name, uuid, size_in_bytes, user_group
    from file_info
    where is_logic_deleted = 0
    and (user_group = 0 or (user_group = 1 and uploader_id = #{userId}))
  </select>

  <select id="selectFileListForUserSelective" resultType="com.yongj.dao.FileInfo">
    select fi.id, fi.name, fi.uuid, fi.size_in_bytes, fi.user_group, fi.uploader_id, fi.uploader_name, fi.upload_time
    from file_info fi
    <if test="p.filterOwnedFiles == false">
      left join file_sharing fs on (fi.id = fs.file_id and fs.user_id = #{p.userId})
    </if>
    <where>
      <choose>
        <when test="p.filterOwnedFiles == true">
          and fi.uploader_id = #{p.userId}
          <if test="p.userGroup != null">
            and fi.user_group = #{p.userGroup}
          </if>
        </when>
        <otherwise>
        <choose>
          <when test="p.userGroup == 0">
            and fi.user_group = 0
          </when>
          <when test="p.userGroup == 1">
            and fi.user_group = 1
            and (
              fi.uploader_id = #{p.userId}
              or (fs.id is not null and fs.is_del = 0)
            )
          </when>
          <otherwise>
            and (
              fi.uploader_id = #{p.userId}
              or (fs.id is not null and fs.is_del = 0)
            )
          </otherwise>
        </choose>
        </otherwise>
      </choose>
      <if test="p.filename != null and p.filename != ''">
        and name like "%"#{p.filename}"%"
      </if>
      and fi.is_logic_deleted = 0
    </where>
    order by id desc
  </select>

  <select id="selectFileListForUserAndTag" resultType="com.yongj.dao.FileInfo">
    select fi.id, fi.name, fi.uuid, fi.size_in_bytes, fi.user_group, fi.uploader_id, fi.uploader_name, fi.upload_time
    from file_info fi
    left join file_sharing fs on (fi.id = fs.file_id and fs.user_id = #{userId})
    left join file_tag ft on fi.id = ft.file_id
    left join tag t on ft.tag_id = t.id
    <where>
      (
          fi.user_group = 0
          or (fi.user_group = 1 and fi.uploader_id = #{userId})
          or fs.id IS NOT NULL
      )
      and t.name = #{tagName}
      <if test="filename != null and filename != ''">
        and fi.name like "%"#{filename}"%"
      </if>
      and fi.is_logic_deleted = 0
    </where>
    order by id desc
  </select>

  <select id="selectValidateInfoById" resultType="com.yongj.dao.FileInfo">
    select fi.id
    from file_info fi
    where fi.id = #{id}
    and (fi.user_group = 0
      or (fi.user_group = 1 and fi.uploader_id = #{userId})
      or exists (select * from file_sharing fs where fs.file_id = fi.id and fs.user_id = #{userId}))
  </select>
  <select id="selectNameById" resultType="java.lang.String">
    select name
    from file_info
    where id = #{id}
  </select>
  <select id="selectUploaderIdById" resultType="java.lang.Integer">
    select uploader_id
    from file_info
    where id = #{id}
  </select>

  <select id="findInfoForPhysicalDeleting" resultType="com.yongj.dao.FileInfo">
    select id, uuid, uploader_id, fs_group_id
    from file_info
    where is_logic_deleted = 1
    and is_physic_deleted = 0
  </select>
  <select id="selectDownloadInfoById" resultType="com.yongj.dao.FileInfo">
    select fs_group_id, uuid, uploader_id
    from file_info
    where id = #{id}
  </select>

</mapper>